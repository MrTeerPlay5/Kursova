<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity Web Player | Turbo_BoardGame</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
  </head>
  <body>
    <!-- –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∞–≤–∏–ª–∞" —Å–ø—Ä–∞–≤–∞ –∑–≤–µ—Ä—Ö—É -->
    <button id="rules-btn" title="–ü—Ä–∞–≤–∏–ª–∞ –≥—Ä–∏">
      <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
        <circle cx="14" cy="14" r="13" fill="#181a1b" stroke="#00c6ff" stroke-width="2"/>
        <text x="14" y="19" text-anchor="middle" fill="#fff" font-size="16" font-family="Segoe UI, Arial, sans-serif" font-weight="bold">i</text>
      </svg>
    </button>
    <div id="rules-modal">
      <div id="rules-content">
        <button id="close-rules">&times;</button>
        <h2>–ü—Ä–∞–≤–∏–ª–∞ –≥—Ä–∏</h2>
        <ol>
          <li>–©–æ–± –∑—Ä–æ–±–∏—Ç–∏ —Ö—ñ–¥, –∫–∏–Ω—å—Ç–µ –∫—É–±–∏–∫.</li>
          <li>–ö–æ–∂–Ω–∞ –∫–ª—ñ—Ç–∏–Ω–∫–∞ –º–æ–∂–µ –º–∞—Ç–∏ —Å–≤–æ—ó —É–Ω—ñ–∫–∞–ª—å–Ω—ñ –¥—ñ—ó –∞–±–æ –±—É—Ç–∏ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ—é.</li>
          <li>–ì—Ä–∞–≤–µ—Ü—å, —è–∫–∏–π –ø–µ—Ä—à–∏–º –¥—ñ–π–¥–µ –¥–æ –∫—ñ–Ω—Ü—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ–ª–∞, –æ—Ç—Ä–∏–º—É—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø–µ—Ä–µ–∫–∏–Ω—É—Ç–∏ –∫—É–±–∏–∫ –∞–±–æ –∫–∏–Ω—É—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π –∫—É–±–∏–∫ —ñ–∑ –º–µ–Ω—à–æ—é –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é —Ö–æ–¥—ñ–≤.</li>
          <li>–ö–æ–ª–∏ –≤—Å—ñ –¥–æ—Ö–æ–¥—è—Ç—å –¥–æ –∫—ñ–Ω—Ü—è –∫—Ä—É–≥—É ‚Äî –∫—Ä—É–≥ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è.</li>
          <li>–ü–µ—Ä–µ–º–∞–≥–∞—î —Ç–æ–π, —Ö—Ç–æ –Ω–∞–±–µ—Ä–µ –Ω–∞–π–±—ñ–ª—å—à—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ—ñ–Ω—Ç—ñ–≤!</li>
          <li>–û—Ç—Ä–∏–º—É–π –ø–æ—ñ–Ω—Ç–∏ –∫–æ–∂–Ω–æ–≥–æ —Ä–∞—É–Ω–¥—É, –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ –≤–∞–∂–∫–æ—Å—Ç—ñ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è —Ü—å–æ–≥–æ –∫–æ–ª–∞.</li>
          <li>–ó –∫–æ–∂–Ω–∏–º –Ω–æ–≤–∏–º –∫–æ–ª–æ–º –≤–≤–æ–¥–∏—Ç—å—Å—è –Ω–æ–≤–µ –ø—Ä–∞–≤–∏–ª–æ, —è–∫–µ –º–æ–∂–µ –∑–º—ñ–Ω–∏—Ç–∏ –≤–µ—Å—å —Ö—ñ–¥ –≥—Ä–∏!</li>
          <li>–ù–∞ –ø–æ–ª—ñ –º–æ–∂—É—Ç—å –∑‚Äô—è–≤–ª—è—Ç–∏—Å—è –±–µ–∑–ø–µ—á–Ω—ñ —à–ª—è—Ö–∏ ‚Äî –≤–æ–Ω–∏ –≤–∏–Ω–∏–∫–∞—é—Ç—å –≤–∏–ø–∞–¥–∫–æ–≤–æ (–º–æ–∂–µ –±—É—Ç–∏ –æ–¥–∏–Ω, –¥–≤–∞, —Ç—Ä–∏ –∞–±–æ —á–æ—Ç–∏—Ä–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ, –≤—Å—å–æ–≥–æ –∑ 4 –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤). –ê–ª–µ –æ–±—Ä–∞–≤—à–∏ —ó—Ö, —Ç–∏ –º–æ–∂–µ—à –≤—Ç—Ä–∞—Ç–∏—Ç–∏ –±–æ–Ω—É—Å–∏, —Ç–æ–º—É –≤–∏—Ä—ñ—à—É–π: —Ä–∏–∑–∏–∫—É–≤–∞—Ç–∏ —á–∏ –Ω—ñ.</li>
        </ol>
      </div>
    </div>
    <div id="unity-container" class="unity-desktop">
      <div id="unity-canvas-wrap">
        <canvas id="unity-canvas" width=960 height=600 tabindex="-1"></canvas> 
        <button id="fullscreen-fixed-btn" class="fullscreen-button">‚õ∂</button>
      </div>
        
      
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>

    <style>
      /* –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∞–≤–∏–ª–∞" */
      #rules-btn {
        position: fixed;
        top: 24px;
        right: 32px;
        z-index: 1001;
        background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        font-size: 26px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 8px 0 rgba(0,0,0,0.12);
        transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
        outline: none;
      }
      #rules-btn:hover, #rules-btn:focus {
        background: linear-gradient(135deg, #0072ff 0%, #00c6ff 100%);
        box-shadow: 0 4px 16px 0 rgba(0,0,0,0.18);
        transform: scale(1.08);
      }
      /* –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ */
      #rules-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0; top: 0; right: 0; bottom: 0;
        width: 100vw; height: 100vh;
        background: rgba(30, 30, 40, 0.55);
        justify-content: center;
        align-items: flex-start;
        padding-top: 60px;
      }
      #rules-content {
        background: #23283a;
        color: #fff;
        border-radius: 18px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        padding: 32px 28px 24px 28px;
        max-width: 420px;
        width: 90vw;
        font-size: 17px;
        position: relative;
        animation: rules-pop 0.25s;
      }
      @keyframes rules-pop {
        from { transform: scale(0.92); opacity: 0; }
        to   { transform: scale(1); opacity: 1; }
      }
      #rules-content h2 {
        margin-top: 0;
        margin-bottom: 18px;
        font-size: 1.5em;
        color: #00c6ff;
        text-align: center;
        letter-spacing: 1px;
      }
      #rules-content ol {
        padding-left: 20px;
        margin: 0;
      }
      #rules-content li {
        margin-bottom: 10px;
        line-height: 1.5;
      }
      #close-rules {
        position: absolute;
        top: 12px;
        right: 16px;
        background: none;
        border: none;
        color: #fff;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
      }
      #close-rules:hover, #close-rules:focus {
        opacity: 1;
        color: #00c6ff;
      }
      @media (max-width: 600px) {
        #rules-content {
          padding: 18px 6vw 14px 6vw;
          font-size: 15px;
        }
        #rules-btn {
          top: 12px;
          right: 10px;
          width: 38px;
          height: 38px;
          font-size: 22px;
        }
      }
      body {
        padding: 0;
        margin: 0;
        position: relative;
        overflow: hidden;
        min-height: 100vh;
        background: linear-gradient(135deg, #232526 0%, #414345 100%);
        font-family: 'Segoe UI', 'Arial', sans-serif;
      }
      #unity-container {
        position: relative;
        width: 960px;
        height: 600px;
        margin: 40px auto 0 auto;
        display: block;
        background: rgba(255,255,255,0.07);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        border-radius: 24px;
        overflow: visible;
        border: 1px solid rgba(255,255,255,0.18);
        backdrop-filter: blur(6px);
      }
      #unity-container.unity-desktop {
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        position: fixed;
      }
      #unity-canvas-wrap {
        position: relative;
        width: 960px;
        height: 600px;
        margin: 0 auto;
        border-radius: 18px;
        overflow: hidden;
        box-shadow: 0 4px 24px 0 rgba(0,0,0,0.15);
      }
      #unity-loading-bar {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        display: none;
        z-index: 10;
        background: rgba(30,30,30,0.85);
        border-radius: 12px;
        padding: 24px 32px;
        box-shadow: 0 2px 16px 0 rgba(0,0,0,0.18);
        min-width: 220px;
      }
      #unity-logo {
        width: 80px;
        height: 80px;
        margin: 0 auto 12px auto;
        background: url('unity-logo-title-footer.png') no-repeat center/contain;
      }
      #unity-progress-bar-empty {
        width: 141px;
        height: 18px;
        margin-top: 10px;
        margin-left: 6.5px;
        background: rgba(255,255,255,0.12);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 4px 0 rgba(0,0,0,0.10);
      }
      #unity-progress-bar-full {
        width: 0%;
        height: 18px;
        margin-top: 0;
        background: linear-gradient(90deg, #00c6ff 0%, #0072ff 100%);
        border-radius: 8px;
        transition: width 0.3s;
      }
      #unity-warning {
        position: absolute;
        left: 50%;
        top: 5%;
        transform: translate(-50%);
        background: #fffbe6;
        color: #333;
        padding: 14px 24px;
        border-radius: 8px;
        box-shadow: 0 2px 8px 0 rgba(0,0,0,0.10);
        display: none;
        font-size: 16px;
        font-weight: 500;
        letter-spacing: 0.5px;
      }
      #unity-footer {
        position: relative;
        margin-top: 18px;
        text-align: center;
        color: #eee;
        font-size: 16px;
        letter-spacing: 1px;
        text-shadow: 0 1px 4px #222;
        padding-bottom: 12px;
        padding-top: 8px;
        border-radius: 0 0 18px 18px;
        background: rgba(0,0,0,0.15);
        font-family: 'Segoe UI', 'Arial', sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
      }
      .footer-title {
        font-weight: 600;
        color: #00c6ff;
        letter-spacing: 1.5px;
      }
      .footer-sep {
        color: #bbb;
        font-size: 18px;
        margin: 0 6px;
      }
      .footer-powered {
        color: #fff;
        font-weight: 400;
        opacity: 0.85;
      }
      .footer-year {
        color: #bbb;
        margin-left: 8px;
        font-size: 15px;
        font-weight: 300;
      }
      @media (max-width: 1000px) {
        #unity-container, #unity-canvas-wrap {
          width: 98vw !important;
          height: 60vw !important;
          min-width: 0 !important;
          min-height: 0 !important;
          max-width: 100vw !important;
          max-height: 100vw !important;
        }
      }
      @media (max-width: 700px) {
        #unity-container, #unity-canvas-wrap {
          width: 100vw !important;
          height: 70vw !important;
        }
        #unity-footer {
          font-size: 13px;
        }
      }
    </style>

    <style>
      #fullscreen-fixed-btn {
        position: fixed;
        right: 20px;
        bottom: 20px;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.5); /* –ß–æ—Ä–Ω–∏–π –Ω–∞–ø—ñ–≤–ø—Ä–æ–∑–æ—Ä–∏–π —Ñ–æ–Ω */
        color: #fff; /* –ë—ñ–ª–∏–π –∫–æ–ª—ñ—Ä —Å–∏–º–≤–æ–ª—É */
        border: none; /* –ë–µ–∑ —Ä–∞–º–∫–∏ */
        border-radius: 50%; /* –ö—Ä—É–≥–ª–∞ —Ñ–æ—Ä–º–∞ */
        width: 50px; /* –†–æ–∑–º—ñ—Ä –∫–Ω–æ–ø–∫–∏ */
        height: 50px;
        font-size: 24px; /* –†–æ–∑–º—ñ—Ä —Å–∏–º–≤–æ–ª—É */
        cursor: pointer; /* –ö—É—Ä—Å–æ—Ä —É –≤–∏–≥–ª—è–¥—ñ —Ä—É–∫–∏ */
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2); /* –õ–µ–≥–∫–∞ —Ç—ñ–Ω—å */
        opacity: 0.7; /* –ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å */
        transition: opacity 0.2s, transform 0.2s; /* –ê–Ω—ñ–º–∞—Ü—ñ—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ */
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #fullscreen-fixed-btn:hover {
        opacity: 1; /* –ó–º–µ–Ω—à–µ–Ω–Ω—è –ø—Ä–æ–∑–æ—Ä–æ—Å—Ç—ñ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ */
        transform: scale(1.1); /* –õ–µ–≥–∫–µ –∑–±—ñ–ª—å—à–µ–Ω–Ω—è */
      }
      </style>
    <!-- ...–¥–∞–ª—ñ –≤–∞—à—ñ —Å—Ç–∏–ª—ñ... -->
    <script>
      let socket = new WebSocket('ws://localhost:8080');

      socket.onopen = () => {
          console.log('üîó WebSocket-–∑ º—î–¥–Ω–∞–Ω–Ω—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
      };

      socket.onmessage = (event) => {
          const message = JSON.parse(event.data);
          console.log('üì© –û—Ç—Ä–∏–º–∞–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ WebSocket:', message);

          // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–æ—Å—É—î—Ç—å—Å—è –ø–æ—Ç–æ—á–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏
          const currentRoomCode = sessionStorage.getItem('roomCode');
          if (message.roomCode === currentRoomCode) {
              console.log('üîÑ –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ –∫—ñ–º–Ω–∞—Ç–∏');
              if (typeof unityInstance !== 'undefined' && unityInstance != null) {
                  // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –æ–± º—î–∫—Ç –∑ —Ä—è–¥–∫–æ–º
                  const playersString = Array.isArray(message.updatedData.players)
                    ? message.updatedData.players.join(",")
                    : message.updatedData.players;

                  const payload = JSON.stringify({
                    RoomCode: message.roomCode,
                    Players: playersString
                  }).trim();

                  console.log("üì§ –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ü–ï–†–ï–§–û–†–ú–ê–¢–û–í–ê–ù–ò–ô JSON –≤ Unity:", payload);
                  unityInstance.SendMessage('WaitingRoom', 'ReUpdatePlayersList', payload);

              }
          }
      };

      socket.onclose = () => {
          console.log('‚ùå WebSocket-–∑ º—î–¥–Ω–∞–Ω–Ω—è –∑–∞–∫—Ä–∏—Ç–æ');
      };

      socket.onerror = (error) => {
          console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ WebSocket:', error);
      };

      var canvas = document.querySelector("#unity-canvas");

      function unityShowBanner(msg, type) {
        var warningBanner = document.querySelector("#unity-warning");
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
        }
        var div = document.createElement('div');
        div.innerHTML = msg;
        warningBanner.appendChild(div);
        if (type == 'error') div.style = 'background: red; padding: 10px;';
        else {
          if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
          setTimeout(function() {
            warningBanner.removeChild(div);
            updateBannerVisibility();
          }, 5000);
        }
        updateBannerVisibility();
      }

      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/WebGLBuild.loader.js";
      var config = {
        arguments: [],
        dataUrl: buildUrl + "/WebGLBuild.data",
        frameworkUrl: buildUrl + "/WebGLBuild.framework.js",
        codeUrl: buildUrl + "/WebGLBuild.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "Turbo_BoardGame",
        productVersion: "1.0",
        showBanner: unityShowBanner,
      };

      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        // Mobile device style: fill the whole browser client area with the game canvas:

        var meta = document.createElement('meta');
        meta.name = 'viewport';
        meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
        document.getElementsByTagName('head')[0].appendChild(meta);
        document.querySelector("#unity-container").className = "unity-mobile";
        canvas.className = "unity-mobile";

      } else {
        // Desktop style: Render the game canvas in a window that can be maximized to fullscreen:
        canvas.style.width = "100vw";
        canvas.style.height = "100vh";
      }

      document.querySelector("#unity-loading-bar").style.display = "block";

      var script = document.createElement("script");
      script.src = loaderUrl;

      var quit = document.createElement("button");
      quit.style = "margin-left: 5px; background-color: lightgray; border: none; padding: 5px; cursor: pointer";
      quit.innerHTML = "Unload";
      quit.onclick = () => {
        unityInstance.Quit().then(() => {
        document.querySelector("#unity-container").remove();
        canvas = null;
        script.remove();
        script = null;
      });
    };

      async function saveProgress(json) {
          console.log("üì• –û—Ç—Ä–∏–º–∞–Ω–æ JSON –∑ Unity:", json);
          try {
              const email = sessionStorage.getItem('userEmail') || 'player@example.com';
              console.log(email);
              const res = await fetch('/api/save-progress', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      email: email,
                      gameState: json
                  })
              });
              const data = await res.json();
              console.log("‚úÖ –°–µ—Ä–≤–µ—Ä –≤—ñ–¥–ø–æ–≤—ñ–≤:", data);
          } catch (err) {
              console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:", err);
          }
      }

      // –ó–±–µ—Ä–µ–∂–µ–º–æ unityInstance –≥–ª–æ–±–∞–ª—å–Ω–æ
      var unityInstance = null;

      // –ü—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è unityInstance ‚Äì –∑–±–µ—Ä–µ–∂—ñ—Ç—å –π–æ–≥–æ:
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          document.querySelector("#unity-progress-bar-full").style.width = 100 * progress + "%";
        }).then((instance) => {
          unityInstance = instance;
          document.querySelector("#unity-loading-bar").style.display = "none";
          sendUserDataToUnity();
        }).catch((message) => {
          alert(message);
        });
      };

      async function loadProgress() {
        console.log("üîµ –í–∏–∫–ª–∏–∫ loadProgress() –∑ Unity");
        try {
          const email = sessionStorage.getItem('userEmail') || 'player@example.com';
          console.log(email);
          const res = await fetch(`/api/load-progress?email=${encodeURIComponent(email)}`, { method: 'GET' });
          const data = await res.json();
          if (res.ok) {
          console.log("‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –¥–∞–Ω—ñ –∑ —Å–µ—Ä–≤–µ—Ä–∞:", data);
          // –ü–µ—Ä–µ–¥–∞—î–º–æ JSON Unity.
            if(unityInstance) {
                unityInstance.SendMessage("Circle", "ApplyLoadedState", JSON.stringify(data));
            } 
          }else {
              console.error("unityInstance is undefined");
              alert(`–î–ª—è email ${email} –∑–±–µ—Ä–µ–∂–µ–Ω—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.`);
          }
        } catch (err) {
          console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö:", err);
        }
      }

      function sendUserDataToUnity() {
        var email = sessionStorage.getItem('userEmail') || '';
        var nickname = sessionStorage.getItem('nickname') || '';
        if (typeof unityInstance !== 'undefined' && unityInstance != null) {
          unityInstance.SendMessage('MainMenu', 'SetUserData', email + "|" + nickname);
        }
        console.log("üì• –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ Unity:", email, nickname);
      }

      function saveWaitingRoom(roomCode, playersStr) {
          console.log("üì• –û—Ç—Ä–∏–º–∞–Ω–æ –∑ Unity: roomCode =", roomCode, "players =", playersStr);
          sessionStorage.setItem('roomCode', roomCode);
          try {
              const email = sessionStorage.getItem('userEmail') || 'player@example.com';
              fetch('/api/save-waiting-room', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      roomCode: roomCode,
                      players: playersStr,
                      adminEmail: email
                  })
              })
              .then(res => res.json())
              .then(data => {
                  console.log("‚úÖ –°–µ—Ä–≤–µ—Ä –≤—ñ–¥–ø–æ–≤—ñ–≤ (–∫—ñ–º–Ω–∞—Ç–∞):", data);
              })
              .catch(err => {
                  console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏:", err);
              });
          } catch (err) {
              console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏:", err);
          }
      }

      function deleteWaitingRoom(roomCode) {
          console.log("üì• –û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏:", roomCode);
          fetch('/api/delete-room', {
              method: 'DELETE',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({ roomCode: roomCode })
          })
          .then(res => res.json())
          .then(data => {
              console.log("‚úÖ –°–µ—Ä–≤–µ—Ä –≤—ñ–¥–ø–æ–≤—ñ–≤ (–≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏):", data);
          })
          .catch(err => {
              console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏:", err);
          });
      }

      function joinWaitingRoom(roomCode) {
          console.log("üì• –û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç –Ω–∞ –≤—Ö—ñ–¥ —É –∫—ñ–º–Ω–∞—Ç—É:", roomCode);

          // ‚úÖ –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∫–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏ –¥–ª—è –≥—Ä–∞–≤—Ü—è, —â–æ –ø—Ä–∏—î–¥–Ω—É—î—Ç—å—Å—è
          sessionStorage.setItem('roomCode', roomCode);

          fetch(`/api/get-room?roomCode=${encodeURIComponent(roomCode)}`, {
              method: 'GET',
              headers: {
                  'Content-Type': 'application/json'
              }
          })
          .then(res => {
              if (!res.ok) {
                  throw new Error(`HTTP –ø–æ–º–∏–ª–∫–∞! –°—Ç–∞—Ç—É—Å: ${res.status}`);
              }
              return res.json();
          })
          .then(data => {
              console.log("‚úÖ –î–∞–Ω—ñ –∫—ñ–º–Ω–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ:", data);

            const roomData = {
            RoomCode: data.RoomCode,
            Players: data.Players
            };
            console.log("roomData", roomData);
            const jsonData = JSON.stringify(roomData);

            console.log("üì§ –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –≤ Unity:", jsonData);
            if (typeof unityInstance !== 'undefined' && unityInstance != null) {
              unityInstance.SendMessage('WaitingRoom', 'LoadRoomData', jsonData);
            }

              // –î–æ–¥–∞—î–º–æ –Ω–æ–≤–æ–≥–æ –≥—Ä–∞–≤—Ü—è –¥–æ —Å–ø–∏—Å–∫—É
              const newPlayer = sessionStorage.getItem('nickname') || 'Anonymous';
              return fetch('/api/update-room-players', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      roomCode: roomCode,
                      newPlayer: newPlayer
                  })
              });
          })
          .then(res => {
              if (!res.ok) {
                  throw new Error(`HTTP –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Å–ø–∏—Å–∫—É –≥—Ä–∞–≤—Ü—ñ–≤! –°—Ç–∞—Ç—É—Å: ${res.status}`);
              }
              return res.json();
          })
          .then(updatedData => {
              console.log("‚úÖ –°–ø–∏—Å–æ–∫ –≥—Ä–∞–≤—Ü—ñ–≤ –æ–Ω–æ–≤–ª–µ–Ω–æ:", updatedData);

              // –ü–µ—Ä–µ–¥–∞—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–∏–π —Å–ø–∏—Å–æ–∫ –≥—Ä–∞–≤—Ü—ñ–≤ —É Unity
              if (typeof unityInstance !== 'undefined' && unityInstance != null) {
                  const playersString = Array.isArray(updatedData.players)
                    ? updatedData.players.join(",")
                    : updatedData.players;

                  const payload = JSON.stringify({
                    RoomCode: updatedData.roomCode,
                    Players: playersString
                  }).trim();

                  console.log("üì§ –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –≤ Unity:", payload);
                  unityInstance.SendMessage('WaitingRoom', 'ReUpdatePlayersList', payload);

              }
          })
          .catch(err => {
              console.error("‚ùå –ü–æ–º–∏–ª–∫–∞:", err);
          });
      }

      document.body.appendChild(script);

      // –ö–æ–¥ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –∑ –ø—Ä–∞–≤–∏–ª–∞–º–∏
      document.getElementById('rules-btn').onclick = function() {
        document.getElementById('rules-modal').style.display = 'flex';
      };
      document.getElementById('close-rules').onclick = function() {
        document.getElementById('rules-modal').style.display = 'none';
      };
      // –ó–∞–∫—Ä–∏—Ç—Ç—è –ø–æ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –≤—ñ–∫–Ω–æ–º
      document.getElementById('rules-modal').onclick = function(e) {
        if (e.target === this) this.style.display = 'none';
      };

    // –û–Ω–æ–≤–ª—é—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å WebSocket
    socket.onmessage = (event) => {
    try {
        const message = JSON.parse(event.data);
        console.log('üì© –û—Ç—Ä–∏–º–∞–Ω–æ WebSocket:', message);
        const currentRoomCode = sessionStorage.getItem('roomCode');

        if (message.roomCode !== currentRoomCode) return;
        if (!unityInstance) return;

        switch (message.type) {
            case 'GAME_STARTED':
                console.log('üèÅ –û—Ç—Ä–∏–º–∞–Ω–æ —Å–∏–≥–Ω–∞–ª —Å—Ç–∞—Ä—Ç—É –≥—Ä–∏! –í–∏–∫–ª–∏–∫–∞—î–º–æ Unity.');
                unityInstance.SendMessage('WaitingRoom', 'HandleGameStarted', JSON.stringify(message.data));
                break;
            case 'PLAYERS_UPDATED':
                console.log('üîÑ –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –≥—Ä–∞–≤—Ü—ñ–≤');
                unityInstance.SendMessage('WaitingRoom', 'ReUpdatePlayersList', JSON.stringify(message.data));
                break;
            case 'TURN_UPDATED':
              console.log('üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ö–æ–¥—É! –ù–æ–≤–∏–π –≥—Ä–∞–≤–µ—Ü—å:', message.data.currentPlayerNickname);
              // ‚úÖ –ó–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –¥–æ –æ–±'—î–∫—Ç–∞, –Ω–∞ —è–∫–æ–º—É –≤–∏—Å–∏—Ç—å TurnManager
              // –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ —Ü–µ–π –æ–±'—î–∫—Ç —É —Å—Ü–µ–Ω—ñ Unity –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è "TurnManager"
              unityInstance.SendMessage('GameManager', 'UpdateGameState', message.data.currentPlayerNickname);
              break;
            case 'POSITIONS_UPDATED':
              console.log('üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ–π –≥—Ä–∞–≤—Ü—ñ–≤:', message.data);
              // –ó–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –¥–æ –æ–±'—î–∫—Ç–∞, –Ω–∞ —è–∫–æ–º—É –≤–∏—Å–∏—Ç—å –≤–∞—à –≥–æ–ª–æ–≤–Ω–∏–π —ñ–≥—Ä–æ–≤–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä
              unityInstance.SendMessage('GameManager', 'ApplyPlayerPositions', JSON.stringify(message.data.playerPositions));
              break;
            case 'PLAYER_FINISHED_LAP':
              console.log('üèÅ –ì—Ä–∞–≤–µ—Ü—å —Ñ—ñ–Ω—ñ—à—É–≤–∞–≤:', message.data.finishedPlayerNickname);
              unityInstance.SendMessage('GameManager', 'HandlePlayerFinished', message.data.finishedPlayerNickname);
              break;
            case 'GLOBAL_EVENT_UPDATE':
              console.log('üîÑ –û—Ç—Ä–∏–º–∞–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —ñ–≤–µ–Ω—Ç—É:', message.data.eventType);
              // –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ —É –≤–∞—Å —î –æ–±'—î–∫—Ç GlobalEventManager —É —Å—Ü–µ–Ω—ñ
              unityInstance.SendMessage('GlobalEventManager', 'HandleGlobalEventUpdate', message.data.eventType);
              break;
            case 'BOARD_UPDATED':
              console.log('üîÑ –û—Ç—Ä–∏–º–∞–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –¥–æ—à–∫–∏:', message.data);
              // –ó–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –¥–æ –æ–±'—î–∫—Ç–∞, –Ω–∞ —è–∫–æ–º—É –≤–∏—Å–∏—Ç—å PathManager
              // –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ —Ü–µ–π –æ–±'—î–∫—Ç —É —Å—Ü–µ–Ω—ñ Unity –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è "PathManager"
              unityInstance.SendMessage('PathManager', 'ApplyBoardState', JSON.stringify(message.data.boardState));
              break;
            case 'NEW_LAP_UPDATE':
              console.log('üîÑ –û—Ç—Ä–∏–º–∞–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –∫–æ–ª–∞:', message.data);
              // –í–∏–∫–ª–∏–∫–∞—î–º–æ –¥–≤–∞ –æ–∫—Ä–µ–º—ñ –º–µ—Ç–æ–¥–∏ –≤ Unity –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
              if (message.data.boardState) {
                unityInstance.SendMessage('PathManager', 'ApplyBoardState', JSON.stringify(message.data.boardState));
              }
              if (message.data.globalEventType !== undefined) {
                unityInstance.SendMessage('GlobalEventManager', 'ApplyGlobalEvent', message.data.globalEventType);
              }
                break;

            default:
            console.warn('–ù–µ–≤—ñ–¥–æ–º–∏–π —Ç–∏–ø –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:', message.type);
        }
    } catch (err) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ WebSocket –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:", err);
    }
};
    
    function updateCurrentPlayerOnServer(roomCode, nextPlayerNickname) {
      console.log(`üöÄ Unity –∑–∞–ø–∏—Ç—É—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ö–æ–¥—É –¥–ª—è –∫—ñ–º–Ω–∞—Ç–∏ ${roomCode}. –ù–∞—Å—Ç—É–ø–Ω–∏–π –≥—Ä–∞–≤–µ—Ü—å: ${nextPlayerNickname}`);
      
      fetch('/api/game/update-turn', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          roomCode: roomCode,
          currentPlayerNickname: nextPlayerNickname // –ù–∞ —Å–µ—Ä–≤–µ—Ä—ñ –º–∏ –Ω–∞–∑–≤–∞–ª–∏ —Ü–µ –ø–æ–ª–µ —Ç–∞–∫
        })
      })
      .then(res => res.json())
      .then(data => console.log('‚úÖ –•—ñ–¥ —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ:', data))
      .catch(err => console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ö–æ–¥—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ:', err));
    }

    // ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ü—é –≤–µ—Ä—Å—ñ—é —Ñ—É–Ω–∫—Ü—ñ—ó, –∞ –¥—Ä—É–≥—É –≤–∏–¥–∞–ª—ñ—Ç—å
    function requestGameStartFull(initialDataJson) {
        const initialData = JSON.parse(initialDataJson);
        console.log(`üöÄ Unity –∑–∞–ø–∏—Ç—É—î —Å—Ç–∞—Ä—Ç –≥—Ä–∏ –¥–ª—è –∫—ñ–º–Ω–∞—Ç–∏ ${initialData.roomCode}.`);
        
        fetch('/api/game/start-full', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(initialData)
        })
        .then(res => res.json())
        .then(data => console.log('‚úÖ –í—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç –≥—Ä–∏:', data))
        .catch(err => console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É –Ω–∞ —Å—Ç–∞—Ä—Ç –≥—Ä–∏:', err));
    }

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –æ–Ω–æ–≤–ª–µ–Ω–∏—Ö –ø–æ–∑–∏—Ü—ñ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    function updatePlayerPositions(roomCode, positionsJson) {
      console.log(`üöÄ Unity –∑–∞–ø–∏—Ç—É—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ–π –¥–ª—è –∫—ñ–º–Ω–∞—Ç–∏ ${roomCode}`);
      
      fetch('/api/game/update-positions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          roomCode: roomCode,
          playerPositions: positionsJson
        })
      })
      .then(res => res.json())
      .then(data => console.log('‚úÖ –í—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ–π:', data))
      .catch(err => console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ–π:', err));
    }
    
    function notifyPlayerFinished(roomCode, nickname) {
      console.log(`üöÄ Unity –ø–æ–≤—ñ–¥–æ–º–ª—è—î: –≥—Ä–∞–≤–µ—Ü—å ${nickname} —Ñ—ñ–Ω—ñ—à—É–≤–∞–≤ —É –∫—ñ–º–Ω–∞—Ç—ñ ${roomCode}`);
      
      fetch('/api/game/player-finished', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          roomCode: roomCode,
          nickname: nickname
        })
      })
      .then(res => res.json())
      .then(data => console.log('‚úÖ –°–µ—Ä–≤–µ—Ä –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤ —Ñ—ñ–Ω—ñ—à –≥—Ä–∞–≤—Ü—è:', data))
      .catch(err => console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —Ñ—ñ–Ω—ñ—à:', err));
    }

    function notifyPlayerJailed(roomCode, nickname) {
      console.log(`üöÄ Unity –ø–æ–≤—ñ–¥–æ–º–ª—è—î: –≥—Ä–∞–≤–µ—Ü—å ${nickname} –ø–æ—Ç—Ä–∞–ø–∏–≤ —É –∫–ª—ñ—Ç–∫—É –≤ –∫—ñ–º–Ω–∞—Ç—ñ ${roomCode}`);
      
      fetch('/api/game/player-jailed', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ roomCode, nickname })
      })
      .then(res => res.json())
      .then(data => console.log('‚úÖ –°–µ—Ä–≤–µ—Ä –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤, —â–æ –≥—Ä–∞–≤–µ—Ü—å —É –∫–ª—ñ—Ç—Ü—ñ:', data))
      .catch(err => console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –∫–ª—ñ—Ç–∫—É:', err));
    }

    // ‚úÖ –ù–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è, —è–∫—É –≤–∏–∫–ª–∏–∫–∞—î Unity
    function broadcastGlobalEvent(eventType) {
      const roomCode = sessionStorage.getItem('roomCode');
      console.log(`üöÄ Unity –∑–∞–ø–∏—Ç—É—î —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—é —ñ–≤–µ–Ω—Ç—É: ${eventType}`);
      
      fetch('/api/game/broadcast-event', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ roomCode, eventType })
      });
    }

    function broadcastBoardState(roomCode, boardStateJson) {
      console.log(`üöÄ Unity –∑–∞–ø–∏—Ç—É—î —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—é –Ω–æ–≤–æ–≥–æ —Å—Ç–∞–Ω—É –¥–æ—à–∫–∏ –¥–ª—è –∫—ñ–º–Ω–∞—Ç–∏ ${roomCode}`);
      
      fetch('/api/game/update-board', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          roomCode: roomCode,
          boardState: boardStateJson
        })
      })
      .then(res => res.json())
      .then(data => console.log('‚úÖ –°–µ—Ä–≤–µ—Ä –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ—à–∫–∏:', data))
      .catch(err => console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ—à–∫–∏:', err));
    }

    // ‚úÖ –ù–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è, —è–∫—É –≤–∏–∫–ª–∏–∫–∞—î Unity
    function broadcastNewLapState(roomCode, combinedDataJson) {
      console.log(`üöÄ Unity –∑–∞–ø–∏—Ç—É—î —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—é –Ω–æ–≤–æ–≥–æ —Å—Ç–∞–Ω—É –∫–æ–ª–∞ –¥–ª—è –∫—ñ–º–Ω–∞—Ç–∏ ${roomCode}`);
      
      fetch('/api/game/new-lap', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          roomCode: roomCode,
          combinedData: combinedDataJson // –ü–µ—Ä–µ–¥–∞—î–º–æ JSON —è–∫ —Ä—è–¥–æ–∫
        })
      });
    }
    </script>

        <script>
          document.addEventListener("DOMContentLoaded", function() {
            var fullscreenButton = document.getElementById('fullscreen-fixed-btn');
            if (fullscreenButton) {
              fullscreenButton.onclick = function() {
                var canvas = document.getElementById('unity-canvas');
                if (canvas.requestFullscreen) {
                  canvas.requestFullscreen();
                } else if (canvas.webkitRequestFullscreen) {
                  canvas.webkitRequestFullscreen();
                } else if (canvas.mozRequestFullScreen) {
                  canvas.mozRequestFullScreen();
                } else if (canvas.msRequestFullscreen) {
                  canvas.msRequestFullscreen();
                }
              };
            } else {
              console.error("–ö–Ω–æ–ø–∫–∞ fullscreen-fixed-btn –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞!");
            }
          });
          </script>

<script>
  window.addEventListener('beforeunload', function (e) {
    if (typeof unityInstance !== 'undefined' && unityInstance != null) {
        var roomCode = sessionStorage.getItem('roomCode');
        if (roomCode) {
            deleteWaitingRoom(roomCode);
        }
    }
});

</script>
      
  </body>
</html>